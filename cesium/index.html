<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>Skrzyczne ‚Äì Snow Coverage AI</title>

  <!-- Cesium -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Cesium.js"></script>
  <link
    href="https://cesium.com/downloads/cesiumjs/releases/1.115/Build/Cesium/Widgets/widgets.css"
    rel="stylesheet"
  />

  <!-- TOKEN CESIUM -->
  <script>
    Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI0YzQ3YzY3Yi1hN2FjLTQ4YTAtOGQ4ZS00MjMxYTkwODQ4ZWIiLCJpZCI6Mzc3MDUzLCJpYXQiOjE3NjgwNTAwNDh9.W2CTDMpelUOrC6cogxWq61-rLKrAidsXlKxCJzGcQ0A";
  </script>

  <style>
    html, body, #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: sans-serif;
    }

    /* Panel info */
    #info {
      position: absolute;
      top: 12px;
      left: 12px;
      background: rgba(0, 0, 0, 0.65);
      color: #fff;
      padding: 10px 14px;
      border-radius: 6px;
      z-index: 1000;
      font-size: 14px;
      line-height: 1.4;
    }

    #info h3 {
      margin: 0 0 6px 0;
      font-size: 16px;
      font-weight: 600;
    }

    /* Suwak przezroczysto≈õci */
    #opacityControl {
      margin-top: 8px;
    }

    /* Suwak dat */
    #dateControl {
      margin-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.3);
      padding-top: 8px;
    }

    #dateSlider {
      width: 100%;
      cursor: pointer;
    }

    #dateLabel {
      margin-top: 4px;
      font-weight: 600;
      color: #ffeb3b;
    }

    /* Przyciski */
    button {
      background: rgba(100, 150, 255, 0.8);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 4px;
      margin-top: 8px;
      font-weight: 600;
      transition: background 0.2s;
    }

    button:hover {
      background: rgba(150, 200, 255, 1);
    }

    button.active {
      background: rgba(255, 200, 100, 0.9);
    }

    /* Sekcja sezonowa */
    #seasonalControl {
      margin-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.3);
      padding-top: 8px;
    }

    #seasonalInfo {
      font-size: 12px;
      margin-top: 6px;
      color: #aaa;
      display: none;
    }

    /* Stoki narciarskie */
    #slopesControl {
      margin-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.3);
      padding-top: 8px;
    }

    #slopesLegend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
      font-size: 12px;
      color: #ddd;
    }

    .swatch {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 2px;
      margin-right: 4px;
      border: 1px solid rgba(255,255,255,0.4);
    }

    .easy { background: #7cfc00; }
    .intermediate { background: #0b2c73; }
    .advanced { background: #e53935; }
    .expert { background: #111; }
  </style>
</head>

<body>

  <!-- PANEL INFO -->
  <div id="info">
    <h3>‚ùÑÔ∏è Skrzyczne</h3>
    Pokrycie ≈õniegiem: <b><span id="snowPercent">...</span></b><br>
    Okres: <span id="dateRange">...</span>

    <div id="opacityControl">
      Przezroczysto≈õƒá:
      <input
        type="range"
        min="0"
        max="100"
        value="80"
        id="opacitySlider"
      />
    </div>

    <div id="dateControl">
      Data:
      <input
        type="range"
        min="0"
        max="0"
        value="0"
        id="dateSlider"
      />
      <div id="dateLabel"></div>
    </div>

    <div id="seasonalControl">
      <button id="dailyBtn" class="active">üìÖ Dzienne</button>
      <button id="seasonalBtn">üó∫Ô∏è Sezonowa</button>
      <div id="seasonalInfo">
        ‚ö™ Bia≈Çy = pewny ≈õnieg (70%+)<br>
        üîµ Niebieski = czƒôsty ≈õnieg (30-70%)
      </div>
    </div>

    <div id="slopesControl">
      <button id="slopesBtn" class="active">‚õ∑Ô∏è Stoki</button>
      <div id="slopesLegend">
        <span><span class="swatch easy"></span>≈Çatwe</span>
        <span><span class="swatch intermediate"></span>≈õrednie</span>
        <span><span class="swatch advanced"></span>trudne</span>
        <span><span class="swatch expert"></span>eksperckie</span>
      </div>
    </div>
  </div>

  <!-- CESIUM -->
  <div id="cesiumContainer"></div>

  <script>
    // ============================    // LISTA DOSTƒòPNYCH DNI
    // ============================"
    const availableDates = [
      "2023-12-05",
      "2023-12-18",
      "2023-12-28",
      "2024-01-09",
      "2024-01-29",
      "2024-02-16"
    ];

    // ============================"    // 1. Viewer
    // ============================
    const viewer = new Cesium.Viewer("cesiumContainer", {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      timeline: false,
      animation: false,
      baseLayerPicker: true,
    });

    // ============================
    // 2. Kamera ‚Äì Skrzyczne
    // ============================
    viewer.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(
        19.03,   // lon
        49.69,   // lat
        2500     // wysoko≈õƒá (m)
      )
    });

    // ============================
    // 3. BBOX (musi siƒô zgadzaƒá z Pythonem) 18,97201
    // ============================
    const rectangle = Cesium.Rectangle.fromDegrees(
      18.97201, 49.66669,
      19.06264,    49.70834
    );

    // ============================
    // 4. WARSTWA ≈öNIEGU (BINARNA)
    // ============================
    let snowLayer = viewer.imageryLayers.addImageryProvider(
      new Cesium.SingleTileImageryProvider({
        url: "png_daily2/snow_2024-01-09.png",
        rectangle: rectangle
      })
    );

    snowLayer.alpha = 0.8;

    let seasonalLayer = null;
    let isSeasonalMode = false;

    // ============================
    // 5. Suwak przezroczysto≈õci
    // ============================
    const slider = document.getElementById("opacitySlider");
    slider.addEventListener("input", () => {
      snowLayer.alpha = slider.value / 100;
    });
    // ============================"
    // 5b. SUWAK DAT (LOGIKA)
    // ============================"
    const dateSlider = document.getElementById("dateSlider");
    const dateLabel = document.getElementById("dateLabel");

    dateSlider.max = availableDates.length - 1;

    function updateSnowLayer(index) {
      const date = availableDates[index];
      dateLabel.innerText = date;

      viewer.imageryLayers.remove(snowLayer);

      snowLayer = viewer.imageryLayers.addImageryProvider(
        new Cesium.SingleTileImageryProvider({
          url: `png_daily2/snow_${date}.png`,
          rectangle: rectangle
        })
      );

      snowLayer.alpha = slider.value / 100;
    }

    dateSlider.addEventListener("input", () => {
      updateSnowLayer(dateSlider.value);
    });

    // Init z pierwszƒÖ datƒÖ
    updateSnowLayer(0);

    // ============================
    // 5c. PRZE≈ÅƒÑCZANIE MAP
    // ============================
    const dailyBtn = document.getElementById("dailyBtn");
    const seasonalBtn = document.getElementById("seasonalBtn");
    const dateControl = document.getElementById("dateControl");
    const seasonalInfo = document.getElementById("seasonalInfo");
    const slopesBtn = document.getElementById("slopesBtn");

    function switchToDaily() {
      isSeasonalMode = false;
      if (seasonalLayer) {
        viewer.imageryLayers.remove(seasonalLayer);
      }
      viewer.imageryLayers.add(snowLayer);
      dateControl.style.display = "block";
      seasonalInfo.style.display = "none";
      dailyBtn.classList.add("active");
      seasonalBtn.classList.remove("active");
    }

    function switchToSeasonal() {
      isSeasonalMode = true;
      if (snowLayer) {
        viewer.imageryLayers.remove(snowLayer);
      }
      if (!seasonalLayer) {
        seasonalLayer = viewer.imageryLayers.addImageryProvider(
          new Cesium.SingleTileImageryProvider({
            url: "png_daily2/snow_seasonal_probability.png",
            rectangle: rectangle
          })
        );
      }
      seasonalLayer.alpha = slider.value / 100;
      viewer.imageryLayers.add(seasonalLayer);
      dateControl.style.display = "none";
      seasonalInfo.style.display = "block";
      dailyBtn.classList.remove("active");
      seasonalBtn.classList.add("active");
    }

    dailyBtn.addEventListener("click", switchToDaily);
    seasonalBtn.addEventListener("click", switchToSeasonal);

    // Update przezroczysto≈õci dla obu map
    const oldSliderListener = slider.onchange;
    slider.addEventListener("input", () => {
      if (isSeasonalMode && seasonalLayer) {
        seasonalLayer.alpha = slider.value / 100;
      } else if (!isSeasonalMode) {
        snowLayer.alpha = slider.value / 100;
      }
    });

    // ============================
    // 6. Stoki narciarskie (GeoJSON)
    // ============================
    let slopesDataSource = null;
    let slopesVisible = true;

    const slopeColors = {
      easy: Cesium.Color.LIME,
      novice: Cesium.Color.LIME,
      intermediate: Cesium.Color.fromCssColorString("#0b2c73"),
      advanced: Cesium.Color.CRIMSON,
      expert: Cesium.Color.BLACK
    };

    function getSlopeColor(diff) {
      const key = (diff || "").toLowerCase();
      return slopeColors[key] || Cesium.Color.ORANGE;
    }

    function styleSlopes(ds) {
      ds.entities.values.forEach((entity) => {
        const diff = entity.properties?.piste_diff?.getValue?.() || "";
        const baseColor = getSlopeColor(diff);
        const fillColor = baseColor.withAlpha(0.65);
        const lineColor = baseColor.withAlpha(0.9);

        if (entity.polygon) {
          entity.polygon.material = fillColor;
          entity.polygon.outline = true;
          entity.polygon.outlineColor = lineColor;
        }

        if (entity.polyline) {
          entity.polyline.material = lineColor;
          entity.polyline.width = 4;
        }

        if (!entity.name) {
          const nameProp = entity.properties?.name?.getValue?.();
          if (nameProp) entity.name = nameProp;
        }
      });
    }

    async function showSlopes() {
      if (!slopesDataSource) {
        slopesDataSource = await Cesium.GeoJsonDataSource.load("trasy_skrzyczne.geojson", {
          clampToGround: true
        });
        styleSlopes(slopesDataSource);
      }
      if (!viewer.dataSources.contains(slopesDataSource)) {
        viewer.dataSources.add(slopesDataSource);
      }
      slopesBtn.classList.add("active");
      slopesVisible = true;
    }

    function hideSlopes() {
      if (slopesDataSource) {
        viewer.dataSources.remove(slopesDataSource, false);
      }
      slopesBtn.classList.remove("active");
      slopesVisible = false;
    }

    slopesBtn.addEventListener("click", () => {
      if (slopesVisible) {
        hideSlopes();
      } else {
        showSlopes();
      }
    });

    showSlopes();
    // ============================
    // 7. Wczytaj statystyki (JSON)
    // ============================
    fetch("stats.json")
      .then(response => response.json())
      .then(data => {
        document.getElementById("snowPercent").innerText =
          data.snow_percent + "%";

        document.getElementById("dateRange").innerText =
          data.date_range;
      })
      .catch(() => {
        document.getElementById("snowPercent").innerText = "brak danych";
      });
  </script>

</body>
</html>
